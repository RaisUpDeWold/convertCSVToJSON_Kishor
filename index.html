<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta content="width=device-width" name="viewport">
        <title>Convert CSV File to JSON</title>
        <style type="text/css">
        output {
            display: block;
            margin-top: 4em;
        }
        </style>
    </head>
    <body>
        <p>Select KISCOURSE.csv File : <input id="kisCoursePicker" type="file" /></p>
        <p>Select CAU-COURSES-unistats16_2016_10_12_14_00_34V1.7.csv File : <input id="cauCoursesPicker" type="file" /></p>
        <p>Select CAU-ORGANISATIONS-20160901 V1.1.csv File : <input id="cauOrganisationsPicker" type="file" /></p>
        <p>Select COURSESTAGE.csv File : <input id="courseStagePicker" type="file" /></p>
        <p>Select INSTITUTION.csv File : <input id="institutionPicker" type="file" /></p>
        <p>Start Index : <input type="text" id="startIndexInput" /></p>
        <p>End Index : <input type="text" id="endIndexInput" /></p>
        <p><input type="button" value="Generate JSON" onclick="generateJSON()" /></p>

        <output id="out">
        </output>

        <script type="text/javascript">
            var mainJSON = {};

            function generateJSON() {
                var startIndex = parseInt(document.getElementById('startIndexInput').value, 10);
                var endIndex = parseInt(document.getElementById('endIndexInput').value, 10);
                
                var UKPRN = Object.keys(mainJSON);
                startIndex = (startIndex >= UKPRN.length)?UKPRN.length - 1 : startIndex;
                endIndex = (endIndex >= UKPRN.length)?UKPRN.length : endIndex;

                document.getElementById('out').innerHTML = '';
                for (var i = startIndex; i < endIndex; i ++) {
                    var KISCOURSEID = Object.keys(mainJSON[UKPRN[i]]);
                    for (var j = 0; j < KISCOURSEID.length; j ++) {
                        var KISMODE = Object.keys(mainJSON[UKPRN[i]][KISCOURSEID[j]]);
                        for (var k = 0; k < KISMODE.length; k ++) {
                            var uniToolTip = UKPRN[i],
                            courseToolTip = UKPRN[i],
                            subjectName = UKPRN[i],
                            subjectToolTip = UKPRN[i],
                            entry = UKPRN[i],
                            entryToolTip = UKPRN[i],
                            UCAS = UKPRN[i],
                            UCASToolTip = UKPRN[i],
                            yearsToolTip = UKPRN[i],
                            qualificationToolTip = UKPRN[i],
                            offers = UKPRN[i],
                            offersToolTip = UKPRN[i],
                            groupUrl = UKPRN[i],
                            groupToolTip = UKPRN[i];
                        
                            addTextNode('{' + '<br>' + 
                                        '"uniName":"' + mainJSON[UKPRN[i]]['uniName'] + '",' + '<br>' +
                                        '"uniUrl":"' + mainJSON[UKPRN[i]]['uniUrl'] + '",' + '<br>' +
                                        '"uniToolTip":"' + uniToolTip + '",' + '<br>' +
                                        '"courseName":"' + mainJSON[UKPRN[i]][KISCOURSEID[j]][KISMODE[k]]['courseName'] + '",' + '<br>' +
                                        '"courseUrl":"' + mainJSON[UKPRN[i]][KISCOURSEID[j]][KISMODE[k]]['courseUrl'] + '",' + '<br>' +
                                        '"courseToolTip":"' + courseToolTip + '",' + '<br>' +
                                        '"subjectName":"' + subjectName + '",' + '<br>' +
                                        '"subjectToolTip":"' + subjectToolTip + '",' + '<br>' +
                                        '"entry":"' + entry + '",' + '<br>' +
                                        '"entryToolTip":"' + entryToolTip + '",' + '<br>' +
                                        '"UCAS":"' + UCAS + '",' + '<br>' +
                                        '"UCASToolTip":"' + UCASToolTip + '",' + '<br>' +
                                        '"years":"' + mainJSON[UKPRN[i]][KISCOURSEID[j]][KISMODE[k]]['years'] + '",' + '<br>' +
                                        '"yearsToolTip":"' + yearsToolTip + '",' + '<br>' +
                                        '"qualification":"' + mainJSON[UKPRN[i]][KISCOURSEID[j]][KISMODE[k]]['qualification'] + '",' + '<br>' +
                                        '"qualificationToolTip":"' + qualificationToolTip + '",' + '<br>' +
                                        '"offers":"' + offers + '",' + '<br>' +
                                        '"offersToolTip":"' + offersToolTip + '",' + '<br>' +
                                        '"group":"' + mainJSON[UKPRN[i]]['group'] + '",' + '<br>' +
                                        '"groupUrl":"' + groupUrl + '",' + '<br>' +
                                        '"groupToolTip":"' + groupToolTip + '",' + '<br>' +
                                        '"rank2011":"' + mainJSON[UKPRN[i]]['rank2011'] + '",' + '<br>' +
                                        '"rank2012":"' + mainJSON[UKPRN[i]]['rank2012'] + '"' + '<br>' +
                                        '},');
                        }
                    }
                }
                alert("Finished Generating");
            }

            function addTextNode(jsonText) {
                var textNode = document.createElement('article');
                textNode.innerHTML = jsonText;
                document.getElementById('out').appendChild(textNode);
            }

            var kisCourseInput = document.getElementById('kisCoursePicker');
            kisCourseInput.addEventListener('change', function() {
                var reader = new FileReader();
                reader.onload = function() {
                    var rows = reader.result.split("\n");
                    for (var i = 0; i < rows.length; i ++) {
                        var rowCols = rows[i].split(",");
                        if (!mainJSON[rowCols[1]]) mainJSON[rowCols[1]] = {};
                        if (!mainJSON[rowCols[1]][rowCols[16]]) mainJSON[rowCols[1]][rowCols[16]] = {};
                        if (!mainJSON[rowCols[1]][rowCols[16]][rowCols[17]]) mainJSON[rowCols[1]][rowCols[16]][rowCols[17]] = {};
                        mainJSON[rowCols[1]][rowCols[16]][rowCols[17]]['courseName'] = rowCols[39] + ' : ' + rowCols[16];
                        mainJSON[rowCols[1]][rowCols[16]][rowCols[17]]['courseUrl'] = rowCols[4];
                    }
                    alert('Finished Reading!');
                };
                reader.readAsBinaryString(kisCourseInput.files[0]);
            });

            var cauCoursesInput = document.getElementById('cauCoursesPicker');
            cauCoursesInput.addEventListener('change', function() {
                var reader = new FileReader();
                reader.onload = function() {
                    var rows = reader.result.split('\n');
                    for (var i = 0; i < rows.length; i ++) {
                        var rowCols = rows[i].split(',');
                        if (mainJSON[rowCols[0]] && mainJSON[rowCols[0]][rowCols[4]] && mainJSON[rowCols[0]][rowCols[4]][rowCols[5]]) {
                            mainJSON[rowCols[0]][rowCols[4]][rowCols[5]]['qualification'] = rowCols[14];
                        }
                    }
                    alert('Finished Reading!');
                };
                reader.readAsBinaryString(cauCoursesInput.files[0]);
            });

            var cauOrganisationsInput = document.getElementById('cauOrganisationsPicker');
            cauOrganisationsInput.addEventListener('change', function() {
                var reader = new FileReader();
                reader.onload = function() {
                    var rows = reader.result.split('\n');
                    for (var i = 0; i < rows.length; i ++) {
                        var rowCols = rows[i].split(',');
                        if (mainJSON[rowCols[0]]) {
                            mainJSON[rowCols[0]]['uniName'] = rowCols[1];
                            mainJSON[rowCols[0]]['group'] = rowCols[4];
                            mainJSON[rowCols[0]]['rank2011'] = rowCols[5];
                            mainJSON[rowCols[0]]['rank2012'] = rowCols[6];
                        }
                    }
                    alert('Finished Reading!');
                };
                reader.readAsBinaryString(cauOrganisationsInput.files[0]);
            });

            var courseStageInput = document.getElementById('courseStagePicker');
            courseStageInput.addEventListener('change', function() {
                var reader = new FileReader();
                reader.onload = function() {
                    var rows = reader.result.split('\n');
                    for (var i = 0; i < rows.length; i ++) {
                        var rowCols = rows[i].split(',');
                        if (mainJSON[rowCols[1]] && mainJSON[rowCols[1]][rowCols[2]] && mainJSON[rowCols[1]][rowCols[2]][rowCols[3]]) {
                            if (!mainJSON[rowCols[1]][rowCols[2]][rowCols[3]]['years']) {
                                mainJSON[rowCols[1]][rowCols[2]][rowCols[3]]['years'] = parseInt(rowCols[11], 10);
                            } else if (mainJSON[rowCols[1]][rowCols[2]][rowCols[3]]['years'] < parseInt(rowCols[11], 10)) {
                                mainJSON[rowCols[1]][rowCols[2]][rowCols[3]]['years'] = parseInt(rowCols[11], 10);
                            }
                        }
                    }
                    alert('Finished Reading');
                };
                reader.readAsBinaryString(courseStageInput.files[0]);
            });

            var institutionInput = document.getElementById('institutionPicker');
            institutionInput.addEventListener('change', function() {
                var reader = new FileReader();
                reader.onload = function() {
                    var rows = reader.result.split('\n');
                    for (var i = 0; i < rows.length; i ++) {
                        var rowCols = rows[i].split(',');
                        if (mainJSON[rowCols[1]]) {
                            mainJSON[rowCols[1]]['uniUrl'] = rowCols[5];
                        }
                    }
                    alert('Finished Reading!');
                };
                reader.readAsBinaryString(institutionInput.files[0]);
            });
        </script>
    </body>
</html>
